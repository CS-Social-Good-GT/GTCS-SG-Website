"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _get2 = _interopRequireDefault(require("lodash/get"));

var _omit3 = _interopRequireDefault(require("lodash/omit"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _dropdownStyle = _interopRequireDefault(require("part:@sanity/components/buttons/dropdown-style"));

var _default = _interopRequireDefault(require("part:@sanity/components/buttons/default"));

var _angleDownIcon = _interopRequireDefault(require("part:@sanity/base/angle-down-icon"));

var _default2 = require("part:@sanity/components/lists/default");

var _poppable = _interopRequireDefault(require("part:@sanity/components/utilities/poppable"));

var _build = _interopRequireDefault(require("boundless-arrow-key-navigation/build"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var modifiers = {
  preventOverflow: {
    boundariesElement: 'window',
    padding: 16
  },
  customStyle: {
    enabled: true,
    fn: data => {
      data.styles = _objectSpread(_objectSpread({}, data.styles), {}, {
        minWidth: "".concat((0, _get2.default)(data, 'offsets.reference.width' || 100), "px")
      });
      return data;
    }
  }
};

function parentButtonIsMenuButton(node, id) {
  var el = node;

  do {
    if (el.tagName === 'BUTTON' && el.dataset.menuButtonId === id) {
      return true;
    }
  } while (el = el.parentNode);

  return false;
}

class DropDownButton extends _react.default.PureComponent {
  constructor(props) {
    super(props);

    _defineProperty(this, "firstItemElement", _react.default.createRef());

    _defineProperty(this, "buttonElement", _react.default.createRef());

    _defineProperty(this, "state", {
      menuOpened: false
    });

    _defineProperty(this, "menuHasKeyboardFocus", false);

    _defineProperty(this, "keyboardNavigation", false);

    _defineProperty(this, "handleClose", evt => {
      if (evt && parentButtonIsMenuButton(evt.target, this.menuId)) {
        // Don't treat clicks on the open menu button as "outside" clicks -
        // prevents us from double-toggling a menu as open/closed
        return;
      }

      this.setState({
        menuOpened: false
      });
    });

    _defineProperty(this, "setMenuElement", element => {
      this._menuElement = element;
    });

    _defineProperty(this, "handleOnClick", event => {
      this.setState((_ref) => {
        var menuOpened = _ref.menuOpened;
        return {
          menuOpened: !menuOpened
        };
      }); // Checks if the onClick comes from pressing the keyboard

      this.keyboardNavigation = event.detail == 0;
    });

    _defineProperty(this, "handleButtonBlur", event => {
      if (this.state.menuOpened && !this.menuHasKeyboardFocus && this.keyboardNavigation) {
        this.handleClose();
      }
    });

    _defineProperty(this, "handleItemClick", (event, item) => {
      event.stopPropagation();
      this.handleAction(item);
    });

    _defineProperty(this, "handleItemKeyPress", (event, item) => {
      if (event.key === 'Enter') {
        this.handleAction(item);
      }
    });

    _defineProperty(this, "handleAction", item => {
      this.props.onAction(item);
      this.handleClose();
      this.keyboardNavigation = false;
    });

    _defineProperty(this, "handleMenuBlur", event => {
      this.menuHasKeyboardFocus = false;
      this.buttonElement.current.focus();
      this.handleClose();
    });

    _defineProperty(this, "handleButtonKeyDown", event => {
      if (event.key == 'ArrowDown' && this.state.menuOpened) {
        this.menuHasKeyboardFocus = true;
        this.keyboardNavigation = true;
        this.firstItemElement.current.focus();
      }
    });

    this.menuId = Math.random().toString(36).substr(2, 6);
  }

  render() {
    var _omit2 = (0, _omit3.default)(this.props, 'onAction'),
        items = _omit2.items,
        renderItem = _omit2.renderItem,
        children = _omit2.children,
        kind = _omit2.kind,
        className = _omit2.className,
        placement = _omit2.placement,
        showArrow = _omit2.showArrow,
        rest = _objectWithoutProperties(_omit2, ["items", "renderItem", "children", "kind", "className", "placement", "showArrow"]);

    var menuOpened = this.state.menuOpened;
    var buttonElement = this.buttonElement && this.buttonElement.current && this.buttonElement.current._element;
    return /*#__PURE__*/_react.default.createElement(_default.default, _extends({}, rest, {
      "data-menu-button-id": this.menuId,
      className: _dropdownStyle.default.button,
      onClick: this.handleOnClick,
      kind: kind,
      onKeyDown: this.handleButtonKeyDown,
      onBlur: this.handleButtonBlur,
      ref: this.buttonElement
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: _dropdownStyle.default.inner
    }, showArrow ? /*#__PURE__*/_react.default.createElement("div", {
      className: _dropdownStyle.default.inner
    }, children, /*#__PURE__*/_react.default.createElement(_angleDownIcon.default, {
      color: "inherit",
      className: _dropdownStyle.default.arrow
    })) : children, /*#__PURE__*/_react.default.createElement(_poppable.default, {
      modifiers: modifiers,
      placement: placement,
      referenceElement: buttonElement,
      onEscape: this.handleClose,
      onClickOutside: this.handleClose,
      referenceClassName: _dropdownStyle.default.outer,
      popperClassName: _dropdownStyle.default.popper,
      positionFixed: true
    }, menuOpened && /*#__PURE__*/_react.default.createElement(_react.Fragment, null, /*#__PURE__*/_react.default.createElement(_default2.List, {
      className: _dropdownStyle.default.list
    }, /*#__PURE__*/_react.default.createElement(_build.default, null, items.map((item, i) => {
      return /*#__PURE__*/_react.default.createElement(_default2.Item, {
        key: i,
        className: _dropdownStyle.default.listItem,
        onClick: event => this.handleItemClick(event, item) //eslint-disable-line react/jsx-no-bind
        ,
        onKeyPress: event => this.handleItemKeyPress(event, item) //eslint-disable-line react/jsx-no-bind
        ,
        item: item,
        tabIndex: 0,
        ref: i === 0 && this.firstItemElement
      }, renderItem(item));
    }))), /*#__PURE__*/_react.default.createElement("div", {
      tabIndex: 0,
      onFocus: this.handleMenuBlur
    })))));
  }

}

exports.default = DropDownButton;

_defineProperty(DropDownButton, "propTypes", {
  kind: _propTypes.default.oneOf(['default', 'simple']),
  items: _propTypes.default.arrayOf(_propTypes.default.shape({
    title: _propTypes.default.string.isRequired,
    icon: _propTypes.default.func
  })),
  onAction: _propTypes.default.func.isRequired,
  children: _propTypes.default.node,
  inverted: _propTypes.default.bool,
  icon: _propTypes.default.func,
  loading: _propTypes.default.bool,
  ripple: _propTypes.default.bool,
  colored: _propTypes.default.bool,
  color: _propTypes.default.string,
  className: _propTypes.default.string,
  renderItem: _propTypes.default.func,
  placement: _propTypes.default.string,
  showArrow: _propTypes.default.bool
});

_defineProperty(DropDownButton, "defaultProps", {
  renderItem(item) {
    return /*#__PURE__*/_react.default.createElement("div", null, item.title);
  },

  showArrow: true,
  placement: 'bottom-start'
});